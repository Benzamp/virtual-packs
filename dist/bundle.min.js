window.CardRenderer={drawR(ctx,x,y,w,h,r,fill,stroke){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();if(fill)ctx.fill();if(stroke)ctx.stroke()},wrapText(ctx,text,x,y,maxWidth,lineHeight){if(!text)return;const words=text.split(" ");let line="";for(let n=0;n<words.length;n++){let testLine=line+words[n]+" ";let metrics=ctx.measureText(testLine);if(metrics.width>maxWidth&&n>0){ctx.fillText(line,x,y);line=words[n]+" ";y+=lineHeight}else{line=testLine}}ctx.fillText(line,x,y)},renderFront(data,userImages){const teamColors=window.TeamColors?window.TeamColors.getColors():{color1:"#fbbf24",color2:"#000000",color3:"#d2c4af"};const canvas=document.getElementById("hidden-canvas-front");const pCanvas=document.getElementById("hidden-canvas-player");const bCanvas=document.getElementById("hidden-canvas-border");const ctx=canvas.getContext("2d");const pCtx=pCanvas.getContext("2d");const bCtx=bCanvas.getContext("2d");const w=1024,h=1480;[ctx,pCtx,bCtx].forEach(c=>c.clearRect(0,0,w,h));if(userImages.layerBg){ctx.drawImage(userImages.layerBg,0,0,w,h)}else{ctx.fillStyle="#1e293b";ctx.fillRect(60,60,w-120,h-120)}if(userImages.layerPlayer){pCtx.drawImage(userImages.layerPlayer,0,0,w,h)}const margin=60;const gap=14;const bannerY=h-320;const tilt=55;bCtx.save();if(userImages.layerBorder){bCtx.drawImage(userImages.layerBorder,0,0,w,h)}bCtx.strokeStyle=teamColors.color1;bCtx.lineWidth=14;this.drawR(bCtx,margin,margin,w-margin*2,h-margin*2,40,false,true);bCtx.strokeStyle=teamColors.color3||"#d2c4af";bCtx.lineWidth=8;const innerM=margin+gap;this.drawR(bCtx,innerM,innerM,w-innerM*2,h-innerM*2,30,false,true);bCtx.beginPath();bCtx.moveTo(margin-20,bannerY);bCtx.lineTo(w-margin+20,bannerY-tilt);bCtx.lineTo(w-margin+20,bannerY+160-tilt);bCtx.lineTo(margin-20,bannerY+160);bCtx.closePath();bCtx.fillStyle=teamColors.color2;bCtx.shadowBlur=15;bCtx.shadowColor="black";bCtx.fill();bCtx.shadowBlur=0;bCtx.strokeStyle=teamColors.color1;bCtx.lineWidth=6;bCtx.stroke();bCtx.restore();const drawBannerText=(text,style)=>{if(!text||!style)return;bCtx.save();const angle=Math.atan2(-tilt,w-margin*2);bCtx.translate(style.x,style.y);bCtx.rotate(angle);bCtx.fillStyle="#FFFFFF";bCtx.font=`bold ${style.size}px "${style.font||"Bebas Neue"}", sans-serif`;bCtx.textAlign="left";bCtx.strokeStyle="black";bCtx.lineWidth=2;bCtx.strokeText(text.toUpperCase(),0,0);bCtx.fillText(text.toUpperCase(),0,0);bCtx.restore()};drawBannerText(data.fName,data.fNameStyle);drawBannerText(data.lName,data.lNameStyle);if(data.pNumber)drawBannerText(`#${data.pNumber}`,data.numStyle,"right");if(data.pPosition)drawBannerText(data.pPosition,data.posStyle,"right");if(userImages.seasonLogo){const sd=data.seasonLogoData;bCtx.save();bCtx.translate(sd?.x||800,sd?.y||200);bCtx.rotate(sd?.rotation||0);const sScale=sd?.scale||1;const sw=userImages.seasonLogo.width*sScale;const sh=userImages.seasonLogo.height*sScale;bCtx.shadowColor="rgba(0,0,0,0.4)";bCtx.shadowBlur=12;bCtx.drawImage(userImages.seasonLogo,-sw/2,-sh/2,sw,sh);bCtx.restore()}const logoImg=userImages.layerLogo||userImages.logoFront;if(logoImg){const ld=data.teamLogoData;bCtx.save();bCtx.translate(ld?.x||512,ld?.y||300);bCtx.rotate(ld?.rotation||0);const lScale=ld?.scale||1;const lw=logoImg.width*lScale;const lh=logoImg.height*lScale;bCtx.drawImage(logoImg,-lw/2,-lh/2,lw,lh);bCtx.restore()}},renderBack(data,userImages){const teamColors=window.TeamColors?window.TeamColors.getColors():{color1:"#fbbf24",color2:"#000000",color3:"#d2c4af"};const canvas=document.getElementById("hidden-canvas-back");const vpCanvas=document.getElementById("hidden-canvas-vp");const lCanvas=document.getElementById("hidden-canvas-league");const ctx=canvas.getContext("2d");const vpCtx=vpCanvas?vpCanvas.getContext("2d"):null;const lCtx=lCanvas?lCanvas.getContext("2d"):null;const w=1024,h=1480;const margin=60;const gap=14;[ctx,vpCtx,lCtx].forEach(c=>c&&c.clearRect(0,0,w,h));if(userImages.back){ctx.drawImage(userImages.back,0,0,w,h)}else{ctx.fillStyle="#f8fafc";ctx.fillRect(0,0,w,h)}if(userImages.teamLogo){ctx.save();ctx.globalAlpha=.15;const watermarkSize=900;ctx.drawImage(userImages.teamLogo,(w-watermarkSize)/2,(h-watermarkSize)/2,watermarkSize,watermarkSize);ctx.restore()}const drawBorderElements=(targetCtx,isBaseLayer)=>{targetCtx.save();if(isBaseLayer&&userImages.layerBorder){targetCtx.drawImage(userImages.layerBorder,0,0,w,h)}targetCtx.strokeStyle=teamColors.color1;targetCtx.lineWidth=14;this.drawR(targetCtx,margin,margin,w-margin*2,h-margin*2,40,false,true);targetCtx.strokeStyle=teamColors.color3||"#d2c4af";targetCtx.lineWidth=8;const innerM=margin+gap;this.drawR(targetCtx,innerM,innerM,w-innerM*2,h-innerM*2,30,false,true);targetCtx.restore()};drawBorderElements(ctx,true);if(vpCtx)drawBorderElements(vpCtx,false);const logoSize=80;const logoY=805;const offsetX=220;if(userImages.logo1){const lx1=w/2-offsetX-logoSize/2;ctx.drawImage(userImages.logo1,lx1,logoY,logoSize,logoSize);if(vpCtx)vpCtx.drawImage(userImages.logo1,lx1,logoY,logoSize,logoSize)}if(userImages.logo2){const lx2=w/2+offsetX-logoSize/2;ctx.drawImage(userImages.logo2,lx2,logoY,logoSize,logoSize);if(lCtx)lCtx.drawImage(userImages.logo2,lx2,logoY,logoSize,logoSize)}const firstName=(data.fName||"FIRST").toUpperCase();const lastName=(data.lName||"LAST").toUpperCase();const jerseyNum=data.pNumber?`#${data.pNumber}`:"#00";const position=data.pPosition||"SS";const nameplateWidth=860;const nameplateX=(w-nameplateWidth)/2;const nameBoxY=170;const nameBoxH=180;const skew=45;ctx.save();ctx.beginPath();ctx.moveTo(nameplateX,nameBoxY);ctx.lineTo(nameplateX+nameplateWidth,nameBoxY-skew);ctx.lineTo(nameplateX+nameplateWidth,nameBoxY+nameBoxH-skew);ctx.lineTo(nameplateX,nameBoxY+nameBoxH);ctx.closePath();ctx.fillStyle="#111";ctx.shadowBlur=15;ctx.shadowColor="rgba(0,0,0,0.4)";ctx.fill();const angle=Math.atan2(-skew,nameplateWidth);ctx.translate(w/2,nameBoxY+65);ctx.rotate(angle);ctx.textAlign="center";ctx.fillStyle=teamColors.color1;ctx.font='bold 32px "Bebas Neue", sans-serif';ctx.letterSpacing="6px";ctx.fillText(firstName,0,-10);ctx.fillStyle="white";ctx.font='italic bold 105px "Bebas Neue", sans-serif';ctx.fillText(lastName,0,85);ctx.restore();const badgeY=375;const badgeW=240,badgeH=55;ctx.fillStyle="#334155";this.drawR(ctx,w/2-badgeW/2,badgeY,badgeW,badgeH,10,true,false);ctx.fillStyle="white";ctx.font='bold 36px "Bebas Neue", sans-serif';ctx.textAlign="center";ctx.fillText(`${jerseyNum}  |  ${position}`,w/2,badgeY+40);const highlightY=580;const plateWidth=w-margin*3;const plateX=(w-plateWidth)/2;ctx.fillStyle="#1e293b";ctx.font='bold 42px "Bebas Neue", sans-serif';ctx.fillText("CAREER HIGHLIGHTS",w/2,highlightY);ctx.fillStyle="#475569";ctx.font=`italic 38px Georgia`;this.wrapText(ctx,data.quote||"NO HIGHLIGHTS PROVIDED",w/2,highlightY+80,plateWidth,48);const statsY=930;ctx.fillStyle=teamColors.color2==="#000000"?"#1e293b":teamColors.color2;this.drawR(ctx,plateX,statsY,plateWidth,60,10,true,false);ctx.fillStyle="white";ctx.font='bold 32px "Bebas Neue", sans-serif';ctx.fillText("SEASON 26 ATTRIBUTES",w/2,statsY+42);const statList=[{l:"SPD",v:data.stats.spd},{l:"AGI",v:data.stats.agi},{l:"STR",v:data.stats.str},{l:"JMP",v:data.stats.jmp},{l:"P RSH",v:data.stats.prsh},{l:"R CVR",v:data.stats.rcvr},{l:"CTH",v:data.stats.cth},{l:"HOT B",v:data.stats.hotb},{l:"TCK",v:data.stats.tck},{l:"STA",v:data.stats.sta},{l:"DUR",v:data.stats.dur},{l:"LDR",v:data.stats.ldr},{l:"CMP",v:data.stats.cmp},{l:"CNST",v:data.stats.cnst},{l:"AGG",v:data.stats.agg}];const rows=3,cols=5;const colWidth=plateWidth/cols;const rowHeight=115;statList.forEach((s,i)=>{const col=i%cols;const row=Math.floor(i/cols);const sx=plateX+col*colWidth+colWidth/2;const sy=statsY+115+row*rowHeight;ctx.fillStyle="#64748b";ctx.font=`bold 24px Arial`;ctx.fillText(s.l,sx,sy);ctx.fillStyle="#0f172a";ctx.font=`900 46px "Bebas Neue", sans-serif`;ctx.fillText(s.v||"-",sx,sy+50);ctx.strokeStyle=teamColors.color1;ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(sx-25,sy+65);ctx.lineTo(sx+25,sy+65);ctx.stroke()})}};window.switchView=function(viewId){const views=["view-home","view-creator","view-vault","view-inspect"];views.forEach(v=>{const el=document.getElementById(v);if(el)el.classList.add("hidden")});const targetView=document.getElementById("view-"+viewId);if(targetView)targetView.classList.remove("hidden");const creatorViewport=document.getElementById("viewport");const inspectViewport=document.getElementById("viewport-inspect");if(window.CardApp&&window.CardApp.renderer){const rendererElement=window.CardApp.renderer.domElement;if(viewId==="inspect"&&inspectViewport){inspectViewport.appendChild(rendererElement);setTimeout(()=>window.CardApp.handleResize("viewport-inspect"),50)}else if(viewId==="creator"&&creatorViewport){creatorViewport.appendChild(rendererElement);setTimeout(()=>window.CardApp.handleResize("viewport"),50)}}if(viewId==="vault"&&window.CardApp.renderGallery){window.CardApp.renderGallery()}};window.toggleIdMode=function(){const mode=document.querySelector('input[name="idMode"]:checked')?.value||"builder";const builderSettings=document.getElementById("builder-settings");if(builderSettings){if(mode==="png"){builderSettings.classList.add("hidden")}else{builderSettings.classList.remove("hidden")}}if(window.CardApp&&window.CardApp.updateCard){window.CardApp.updateCard()}};window.toggleNickSettings=function(){const drawer=document.getElementById("nickSettings");if(drawer)drawer.classList.toggle("hidden")};window.UIHandler={init(){this.bindFileUpload("imgLayerBg","layerBg");this.bindFileUpload("imgLayerPlayer","layerPlayer");this.bindFileUpload("imgLayerBorder","layerBorder");this.bindFileUpload("imgBack","back");this.bindFileUpload("logo1","logo1");this.bindFileUpload("logo2","logo2");this.bindFileUpload("teamLogo","teamLogo");this.bindFileUpload("imgLayerLogo","layerLogo");this.bindFileUpload("imgLayerSeason","seasonLogo");["input","change"].forEach(eventType=>{document.addEventListener(eventType,e=>{if(e.target.closest(".sidebar")){if(window.CardApp&&window.CardApp.updateCard){window.CardApp.updateCard()}}})})},bindFileUpload(id,key){const el=document.getElementById(id);if(!el)return;el.onchange=e=>{const reader=new FileReader;reader.onload=ev=>{const img=new Image;img.onload=()=>{window.CardApp.userImages[key]=img;console.log(`Uploaded ${key}:`,window.CardApp.userImages);window.CardApp.updateCard()};img.src=ev.target.result};if(e.target.files[0])reader.readAsDataURL(e.target.files[0])}},getFormData(){const getVal=id=>document.getElementById(id)?.value||"";const getNum=id=>parseFloat(document.getElementById(id)?.value||0);const getChecked=id=>document.getElementById(id)?.checked||false;const mode=document.querySelector('input[name="idMode"]:checked')?.value||"builder";const currentCount=parseInt(localStorage.getItem("vsc_counter")||"0");const previewSerial=`VP-${currentCount+1}`;["X","Y","Rot","Scale"].forEach(s=>{const label=document.getElementById(`val${s}`);const input=document.getElementById(`nick${s}`);if(label&&input)label.innerText=input.value;const sLabel=document.getElementById(`valSeason${s}`);const sInput=document.getElementById(`season${s}`);if(sLabel&&sInput)sLabel.innerText=sInput.value});return{mode:mode,serial:previewSerial,fName:getVal("fName"),fNameStyle:{x:getNum("fNameX"),y:getNum("fNameY"),rot:getNum("fNameRot"),size:getNum("fNameSize"),font:getVal("fNameFont")},numStyle:{x:parseFloat(document.getElementById("numX").value)||65,y:parseFloat(document.getElementById("numY").value)||1240,rot:parseFloat(document.getElementById("numRot").value)||0,size:parseFloat(document.getElementById("numSize").value)||55},posStyle:{x:parseFloat(document.getElementById("posX").value)||980,y:parseFloat(document.getElementById("posY").value)||1260,rot:parseFloat(document.getElementById("posRot").value)||0,size:parseFloat(document.getElementById("posSize").value)||50},pNumber:getVal("pNumber"),pPosition:getVal("pPosition"),lName:getVal("lName"),lNameStyle:{x:getNum("lNameX"),y:getNum("lNameY"),rot:getNum("lNameRot"),size:getNum("lNameSize"),font:getVal("lNameFont")},team:getVal("team"),teamColor:getVal("teamColor"),teamFont:getVal("teamFont"),teamLogoData:{x:parseFloat(document.getElementById("logoX").value)||512,y:parseFloat(document.getElementById("logoY").value)||250,scale:parseFloat(document.getElementById("logoScale").value)||1,rotation:(parseFloat(document.getElementById("logoRot").value)||0)*(Math.PI/180)},seasonLogoData:{x:parseFloat(document.getElementById("seasonX")?.value)||800,y:parseFloat(document.getElementById("seasonY")?.value)||200,scale:parseFloat(document.getElementById("seasonScale")?.value)||1,rotation:(parseFloat(document.getElementById("seasonRot")?.value)||0)*(Math.PI/180)},rarityTier:getVal("rarityTier"),themeColor:getVal("themeColor"),isFoil:getChecked("isFoil"),holoBg:document.getElementById("holoBg")?.checked||false,holoPlayer:document.getElementById("holoPlayer")?.checked||false,holoBorder:document.getElementById("holoBorder")?.checked||false,quote:getVal("quote"),stats:{spd:getVal("spd"),agi:getVal("agi"),str:getVal("str"),jmp:getVal("jmp"),prsh:getVal("prsh"),rcvr:getVal("rcvr"),cth:getVal("cth"),hotb:getVal("hotb"),tck:getVal("tck"),sta:getVal("sta"),dur:getVal("dur"),ldr:getVal("ldr"),cmp:getVal("cmp"),cnst:getVal("cnst"),agg:getVal("agg")}}}};const cardVertexShader=`\n    varying vec2 vUv;\n    varying vec3 vNormal;\n    varying vec3 vWorldPos;\n\n    void main() {\n        vUv = uv;\n        vNormal = normalize(normalMatrix * normal);\n        vec4 worldPos = modelMatrix * vec4(position, 1.0);\n        vWorldPos = worldPos.xyz;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    }\n`;const cardFragmentShader=`\n    precision highp float;\n    #define PI 3.14159265\n    varying vec2 vUv;\n    varying vec3 vNormal;\n    varying vec3 vWorldPos;\n\n    uniform sampler2D map;\n    uniform sampler2D envMap2D;\n    uniform sampler2D uFlakeMap;\n    \n    uniform vec3 uCameraPos;\n    uniform float uFlakesEnabled;\n    uniform float uFlakeSize;\n    uniform float uFlakeReduction;\n    uniform float uFlakeBrightness;\n    uniform float uMetalness;\n    uniform float uIridescence;\n    uniform float uEnvIntensity;\n\n    float luminance(vec3 color) {\n        return dot(color, vec3(0.2126, 0.7152, 0.0722));\n    }\n\n    vec2 dirToEquirectUv(vec3 dir) {\n        dir = normalize(dir);\n        float phi = atan(dir.z, dir.x);\n        float theta = acos(clamp(dir.y, -1.0, 1.0));\n        return vec2((phi + PI) / (2.0 * PI), theta / PI);\n    }\n\n    vec3 iridescenceColor(float cosTheta) {\n        float phase = 6.28318 * (0.2 + 0.5 * (1.0 - cosTheta));\n        vec3 rainbow = 0.5 + 0.5 * vec3(sin(phase), sin(phase + 2.094), sin(phase + 4.188));\n        return mix(vec3(1.0), rainbow, uIridescence);\n    }\n\n    void main() {\n        vec4 base = texture2D(map, vUv);\n        \n        // DISCARD transparent pixels (This acts as our mask for the layers)\n        if(base.a < 0.1) discard;\n\n        vec3 N = normalize(vNormal);\n        vec3 V = normalize(uCameraPos - vWorldPos);\n        vec3 R = reflect(-V, N);\n        float cosTheta = clamp(dot(N, V), 0.0, 1.0);\n\n        vec3 env = texture2D(envMap2D, dirToEquirectUv(R)).rgb * uEnvIntensity;\n        vec3 iri = iridescenceColor(cosTheta);\n        vec3 holoTint = base.rgb * iri;\n        \n        vec3 sparkleCol = vec3(0.0);\n        if(uFlakesEnabled > 0.5) {\n            vec4 flakeTex = texture2D(uFlakeMap, vUv * uFlakeSize);\n            float mask = smoothstep(uFlakeReduction, 1.0, flakeTex.r);\n            \n            vec3 flakeNorm = normalize(N + vec3((flakeTex.r - 0.5) * 0.7, (flakeTex.g - 0.5) * 0.7, (flakeTex.b - 0.5) * 0.7));\n            vec3 PR = reflect(-V, flakeNorm);\n            float lightHit = luminance(texture2D(envMap2D, dirToEquirectUv(PR)).rgb);\n            \n            float glint = pow(lightHit, 16.0) * mask; \n            vec3 fire = 0.5 + 0.5 * cos(6.28318 * (flakeTex.g + vec3(0, 1, 2) / 3.0));\n            sparkleCol = glint * fire * uFlakeBrightness * 100.0;\n        }\n\n        // Apply holographic effect\n        vec3 diffuse = mix(base.rgb, holoTint, uMetalness);\n        vec3 specular = (env * 0.4) * iri * uMetalness;\n        vec3 finalColor = diffuse + specular + sparkleCol + (iri * 0.1);\n        \n        gl_FragColor = vec4(finalColor, base.a);\n    }\n`;window.CardApp={scene:null,camera:null,renderer:null,cardMesh:null,envMap:null,flakeMap:null,isFlipped:false,userImages:{layerBg:null,layerPlayer:null,layerBorder:null,back:null,logo1:null,logo2:null,teamLogo:null,seasonLogo:null},flakeOptions:["broken-glass.jpg","flakes.jpg","gold.jpg","oil.jpg","shards.jpg","fire.jpg","foil1.jpg","checkered.jpg","geometric.jpg","geometric2.jpg","retro.jpg","stained-glass.jpg","hogs-tiled.jpg"],rotationVelocity:{x:0,y:0},friction:.95,isDragging:false,init(){const viewport=document.getElementById("viewport");if(!viewport)return;window.UIHandler?.init();this.scene=new THREE.Scene;this.camera=new THREE.PerspectiveCamera(35,viewport.clientWidth/viewport.clientHeight,.1,1e3);this.camera.position.z=12;this.renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});this.renderer.setSize(viewport.clientWidth,viewport.clientHeight);this.renderer.setPixelRatio(window.devicePixelRatio);this.renderer.outputColorSpace=THREE.SRGBColorSpace;viewport.appendChild(this.renderer.domElement);const loader=new THREE.TextureLoader;loader.setCrossOrigin("anonymous");this.envMap=loader.load("assets/environment-maps/studio_small_09.jpg",tex=>{tex.mapping=THREE.EquirectangularReflectionMapping;this.updateCard()});this.flakeMap=loader.load("assets/foil-textures/broken-glass.jpg",tex=>{const imageRatio=tex.image.width/tex.image.height;if(imageRatio>1){tex.rotation=Math.PI/2;tex.center.set(.5,.5)}tex.wrapS=tex.wrapT=THREE.RepeatWrapping;this.updateCard()});window.CardApp.handleLogoUpload=input=>{if(input.files&&input.files[0]){const reader=new FileReader;reader.onload=e=>{const img=new Image;img.onload=()=>{this.userImages.logoFront=img;this.updateCard()};img.src=e.target.result};reader.readAsDataURL(input.files[0])}};this.cardstockBumpMap=loader.load("assets/textures/cardstock.jpg",tex=>{tex.wrapS=tex.wrapT=THREE.RepeatWrapping;tex.repeat.set(5,5)});const ambient=new THREE.AmbientLight(16777215,1.1);this.scene.add(ambient);this.createFlakeDropdown();this.setupInteraction();this.updateCard();this.animate();this.loadLatestCard();window.addEventListener("resize",()=>this.handleResize())},exportCardAsGif(){const duration=2;const fps=30;const totalFrames=duration*fps;const webglCanvas=this.renderer.domElement;const capturer=new CCapture({format:"gif",workersPath:"js/libs/",framerate:fps,quality:10});alert("Starting GIF capture. The card will rotate and a download will trigger once finished.");const originalRotationY=this.cardMesh.rotation.y;let captureData={frame:0};gsap.to(captureData,{frame:totalFrames,duration:duration,ease:"none",onStart:()=>{capturer.start()},onUpdate:()=>{const progress=captureData.frame/totalFrames;this.cardMesh.rotation.y=originalRotationY+Math.PI*2*progress;this.renderer.render(this.scene,this.camera);capturer.capture(webglCanvas)},onComplete:()=>{capturer.stop();capturer.save();this.cardMesh.rotation.y=originalRotationY;console.log("Capture Finished")}})},createFlakeDropdown(){const container=document.getElementById("ui-controls");if(!container)return;const wrapper=document.createElement("div");wrapper.style.padding="10px";wrapper.style.background="rgba(0,0,0,0.5)";wrapper.style.borderRadius="5px";wrapper.style.marginTop="10px";const label=document.createElement("label");label.innerText="Foil Pattern: ";label.style.color="white";label.style.fontSize="12px";const select=document.createElement("select");select.style.background="#222";select.style.color="white";select.style.border="1px solid #444";this.flakeOptions.forEach(fileName=>{const option=document.createElement("option");option.value=`assets/foil-textures/${fileName}`;option.innerText=fileName.replace(".jpg","").toUpperCase();select.appendChild(option)});select.addEventListener("change",e=>this.changeFlakeTexture(e.target.value));wrapper.appendChild(label);wrapper.appendChild(select);container.appendChild(wrapper)},changeFlakeTexture(path){const loader=new THREE.TextureLoader;loader.load(path,tex=>{tex.wrapS=tex.wrapT=THREE.RepeatWrapping;this.flakeMap=tex;this.updateCard()})},handleResize(){const vp=document.getElementById("viewport");if(!vp||!this.camera||!this.renderer)return;this.camera.aspect=vp.clientWidth/vp.clientHeight;this.camera.updateProjectionMatrix();this.renderer.setSize(vp.clientWidth,vp.clientHeight)},updateCard(vaultData=null){if(!window.CardApp||!window.CardRenderer)return;const data=vaultData||window.UIHandler.getFormData();let currentRotation={x:0,y:0,z:0};if(this.cardMesh){currentRotation.x=this.cardMesh.rotation.x;currentRotation.y=this.cardMesh.rotation.y;currentRotation.z=this.cardMesh.rotation.z}window.CardRenderer.renderFront(data,this.userImages);window.CardRenderer.renderBack(data,this.userImages);const getCanvasTex=id=>{const el=document.getElementById(id);if(!el)return null;const tex=new THREE.CanvasTexture(el);tex.flipY=true;tex.anisotropy=this.renderer.capabilities.getMaxAnisotropy();return tex};const texF=getCanvasTex("hidden-canvas-front");const texB=getCanvasTex("hidden-canvas-back");const texP=getCanvasTex("hidden-canvas-player");const texBorder=getCanvasTex("hidden-canvas-border");const texVP=getCanvasTex("hidden-canvas-vp");const texLL=getCanvasTex("hidden-canvas-league");const texTeamLogo=getCanvasTex("hidden-canvas-team-logo");if(this.cardMesh){this.cardMesh.traverse(child=>{if(child.isMesh){child.geometry.dispose();if(Array.isArray(child.material)){child.material.forEach(m=>m.dispose())}else{child.material.dispose()}}});this.scene.remove(this.cardMesh)}const sideMat=new THREE.MeshStandardMaterial({color:1118481});const backMat=new THREE.MeshStandardMaterial({map:texB,envMap:this.envMap,roughness:.9,metalness:0,envMapIntensity:.1,bumpMap:this.cardstockBumpMap,bumpScale:.015});const getMaterial=(tex,isHoloEnabled,isTransparent=false)=>{const shouldShowHolo=isHoloEnabled;if(shouldShowHolo){return new THREE.ShaderMaterial({uniforms:{map:{value:tex},envMap2D:{value:this.envMap},uFlakeMap:{value:this.flakeMap},uCameraPos:{value:(new THREE.Vector3).copy(this.camera.position)},uFlakesEnabled:{value:1},uFlakeSize:{value:1},uFlakeReduction:{value:.65},uFlakeBrightness:{value:.18},uMetalness:{value:.4},uIridescence:{value:.8},uEnvIntensity:{value:1.2}},vertexShader:cardVertexShader,fragmentShader:cardFragmentShader,transparent:true,depthWrite:!isTransparent})}return new THREE.MeshStandardMaterial({map:tex,envMap:this.envMap,envMapIntensity:.4,transparent:isTransparent,alphaTest:isTransparent?.1:0,roughness:.8,metalness:.1})};const frontMat=getMaterial(texF,data.holoBg,false);this.cardMesh=new THREE.Mesh(new THREE.BoxGeometry(3.5,5,.1),[sideMat,sideMat,sideMat,sideMat,frontMat,backMat]);this.cardMesh.rotation.set(currentRotation.x,currentRotation.y,currentRotation.z);this.scene.add(this.cardMesh);const pMat=getMaterial(texP,data.holoPlayer,true);const pMesh=new THREE.Mesh(new THREE.PlaneGeometry(3.5,5),pMat);pMesh.position.z=.051;this.cardMesh.add(pMesh);const bMat=getMaterial(texBorder,data.holoBorder,true);const bMesh=new THREE.Mesh(new THREE.PlaneGeometry(3.5,5),bMat);bMesh.position.z=.052;this.cardMesh.add(bMesh);const tlMat=getMaterial(texTeamLogo,true,true);const tlMesh=new THREE.Mesh(new THREE.PlaneGeometry(3.5,5),tlMat);tlMesh.position.z=-.0505;tlMesh.rotation.y=Math.PI;this.cardMesh.add(tlMesh);const logo1Mesh=new THREE.Mesh(new THREE.PlaneGeometry(3.5,5),getMaterial(texVP,data.isFoil,true));logo1Mesh.position.z=-.051;logo1Mesh.rotation.y=Math.PI;this.cardMesh.add(logo1Mesh);const logo2Mesh=new THREE.Mesh(new THREE.PlaneGeometry(3.5,5),getMaterial(texLL,data.isFoil,true));logo2Mesh.position.z=-.052;logo2Mesh.rotation.y=Math.PI;this.cardMesh.add(logo2Mesh)},generateNoiseTexture(size=128){const canvas=document.createElement("canvas");canvas.width=canvas.height=size;const ctx=canvas.getContext("2d");const imageData=ctx.createImageData(size,size);const data=imageData.data;for(let i=0;i<data.length;i+=4){const val=Math.random()*255;data[i]=val;data[i+1]=val;data[i+2]=val;data[i+3]=255}ctx.putImageData(imageData,0,0);const tex=new THREE.CanvasTexture(canvas);tex.wrapS=tex.wrapT=THREE.RepeatWrapping;tex.repeat.set(4,4);return tex},animate(){requestAnimationFrame(()=>this.animate());if(this.cardMesh){if(!this.isDragging){this.cardMesh.rotation.x+=this.rotationVelocity.x;this.cardMesh.rotation.y+=this.rotationVelocity.y;this.rotationVelocity.x*=this.friction;this.rotationVelocity.y*=this.friction;if(Math.abs(this.rotationVelocity.x)<1e-4)this.rotationVelocity.x=0;if(Math.abs(this.rotationVelocity.y)<1e-4)this.rotationVelocity.y=0}if(this.camera){const camPos=this.camera.position;if(this.cardMesh.material[4]?.type==="ShaderMaterial"){this.cardMesh.material[4].uniforms.uCameraPos.value.copy(camPos)}this.cardMesh.children.forEach(child=>{if(child.material&&child.material.type==="ShaderMaterial"){child.material.uniforms.uCameraPos.value.copy(camPos)}});const resetBtn=document.getElementById("reset-view-btn");if(resetBtn){const isRotated=Math.abs(this.cardMesh.rotation.x)>.01||Math.abs(this.cardMesh.rotation.y)>.01;const isZoomed=Math.abs(this.camera.position.z-12)>.1;const isPanned=Math.abs(this.camera.position.x)>.1||Math.abs(this.camera.position.y)>.1;if(isRotated||isZoomed||isPanned){resetBtn.classList.remove("hidden")}else{resetBtn.classList.add("hidden")}}}}this.renderer.render(this.scene,this.camera)},flipCard(){if(!this.cardMesh)return;this.isFlipped=!this.isFlipped;const targetY=this.isFlipped?Math.PI:0;gsap.to(this.cardMesh.rotation,{y:targetY,duration:.6,ease:"back.out(1.2)"})},resetView(){if(!this.cardMesh||!this.camera)return;gsap.to(this.cardMesh.rotation,{x:0,y:0,z:0,duration:.8,ease:"power2.out"});gsap.to(this.camera.position,{x:0,y:0,z:12,duration:.8,ease:"power2.out",onComplete:()=>{document.getElementById("reset-view-btn")?.classList.add("hidden")}});this.isFlipped=false},setupInteraction(){let prev={x:0,y:0};let pan=false;window.addEventListener("contextmenu",e=>{if(e.target.closest("#viewport"))e.preventDefault()});window.addEventListener("mousedown",e=>{if(e.target.closest("#viewport")){if(e.button===0){this.isDragging=true;this.rotationVelocity={x:0,y:0}}if(e.button===2){pan=true}prev={x:e.clientX,y:e.clientY}}});window.addEventListener("mouseup",()=>{this.isDragging=false;pan=false});window.addEventListener("mousemove",e=>{if(!this.cardMesh)return;const deltaX=e.clientX-prev.x;const deltaY=e.clientY-prev.y;if(this.isDragging){this.rotationVelocity.y=deltaX*.015;this.rotationVelocity.x=deltaY*.015;this.cardMesh.rotation.y+=this.rotationVelocity.y;this.cardMesh.rotation.x+=this.rotationVelocity.x}else if(pan){gsap.to(this.camera.position,{x:this.camera.position.x-deltaX*.01,y:this.camera.position.y+deltaY*.01,duration:.5,ease:"power2.out"})}prev={x:e.clientX,y:e.clientY}});window.addEventListener("wheel",e=>{if(e.target.closest("#viewport")){e.preventDefault();const speedMultiplier=1.5;const delta=e.deltaY*speedMultiplier;let targetZ=this.camera.position.z+delta*.005;targetZ=Math.min(Math.max(targetZ,5),18);gsap.to(this.camera.position,{z:targetZ,duration:.4,ease:"power2.out",overwrite:"auto"})}},{passive:false})},async saveToVault(){const formData=window.UIHandler.getFormData();const customName=prompt("Card Name:",`${formData.fName} ${formData.lName}`);if(!customName)return;const customSeason=prompt("Season:","2026");if(!customSeason)return;try{const cardRecord={cardName:customName,cardSeason:customSeason,fName:formData.fName,lName:formData.lName,team:formData.team,pPosition:formData.pPosition,pNumber:formData.pNumber,quote:formData.quote,themeColor:formData.themeColor,holoBg:formData.holoBg,holoPlayer:formData.holoPlayer,holoBorder:formData.holoBorder,fNameStyle:formData.fNameStyle,lNameStyle:formData.lNameStyle,numStyle:formData.numStyle,posStyle:formData.posStyle,teamLogoData:formData.teamLogoData,seasonLogoData:formData.seasonLogoData,stats:formData.stats,config:formData};this.renderer.render(this.scene,this.camera);const blob=await new Promise(res=>this.renderer.domElement.toBlob(res,"image/webp",.8));const fileName=`card_${Date.now()}.webp`;const{data:storageData,error:sErr}=await window.supabase.storage.from("card-thumbnails").upload(fileName,blob);if(sErr)throw sErr;const{data:urlData}=window.supabase.storage.from("card-thumbnails").getPublicUrl(fileName);cardRecord.image_url=urlData.publicUrl;const{error:iErr}=await window.supabase.from("cards").insert([cardRecord]);if(iErr)throw iErr;alert("Card saved successfully!");this.renderGallery()}catch(err){alert("Save failed: "+err.message)}},async loadLatestCard(){try{const{data:record,error:error}=await window.supabase.from("cards").select("*").order("created_at",{ascending:false}).limit(1).single();if(error){console.log("No previous cards found or error fetching:",error.message);return}if(record){console.log("Loading most recent card:",record.fName);this.applyDataToUI(record.config);this.updateCard()}}catch(err){console.error("Fetch error:",err)}},async loadFromVault(recordId){console.log("Attempting to load card with ID:",recordId);if(!recordId||recordId==="undefined"){return alert("Error: Invalid Card ID. Please try refreshing the gallery.")}try{const{data:record,error:error}=await window.supabase.from("cards").select("*").eq("id",recordId).single();if(error||!record){console.error("Supabase Error:",error);return alert("Card not found in the cloud vault.")}if(record.config){this.applyDataToUI(record.config);this.updateCard();if(typeof switchView==="function")switchView("creator")}else{alert("This card has no configuration data saved.")}}catch(err){console.error("Critical Load Error:",err)}},applyDataToUI(data){if(!data)return;Object.keys(data).forEach(key=>{const el=document.getElementById(key);if(el){el.value=data[key];el.dispatchEvent(new Event("input"))}if(typeof data[key]==="object"&&data[key]!==null){Object.keys(data[key]).forEach(subKey=>{const subEl=document.getElementById(subKey);if(subEl){subEl.value=data[key][subKey];subEl.dispatchEvent(new Event("input"))}})}})},applyDataToUI(data){Object.keys(data).forEach(key=>{const el=document.getElementById(key);if(el)el.value=data[key]})},async renderGallery(){const gallery=document.getElementById("card-gallery");if(!gallery)return;gallery.innerHTML='<div class="loader">Accessing Cloud Vault...</div>';try{const{data:cards,error:error}=await window.supabase.from("cards").select("*").order("created_at",{ascending:false});if(error)throw error;if(!cards||cards.length===0){gallery.innerHTML='<p style="color: #888; text-align: center; padding: 20px;">No cards found in cloud vault.</p>';return}gallery.innerHTML="";cards.forEach(card=>{const item=document.createElement("div");item.className="menu-btn";item.style.height="auto";if(!card.id)console.error("Database record missing ID for:",card.cardName);item.innerHTML=`\n                    <div style="margin-bottom: 10px; position: relative; min-height: 100px; background: #222;">\n                        <img src="${card.image_url}" \n                            onerror="this.src='assets/placeholder.png'; this.style.opacity='0.5';"\n                            style="width: 100%; border-radius: 4px; border: 1px solid #444; display: block;">\n                    </div>\n                    <span class="label" style="display: block; font-weight: bold;">${card.cardName||"Unnamed"}</span>\n                    <small style="color: #aaa;">Season: ${card.cardSeason} | ${card.team}</small>\n                    \n                    <button onclick="window.CardApp.loadFromVault('${card.id}')" \n                            style="width: 100%; margin-top: 10px; background: #8b5cf6; color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">\n                        LOAD DATA\n                    </button>\n                `;gallery.appendChild(item)})}catch(err){console.error("Gallery Load Error:",err.message);gallery.innerHTML=`<p style="color: #ff4444;">Error loading vault: ${err.message}</p>`}}};window.addEventListener("load",()=>window.CardApp.init());window.TeamColors={colors:{color1:"#ff4444",color2:"#44ff44",color3:"#4444ff"},init(){this.loadColors();this.setupColorPickers();this.setupButtons()},loadColors(){const saved=localStorage.getItem("teamColors");if(saved){this.colors=JSON.parse(saved);this.applyColors()}},applyColors(){document.getElementById("color1").value=this.colors.color1;document.getElementById("color2").value=this.colors.color2;document.getElementById("color3").value=this.colors.color3;document.getElementById("hex1").textContent=this.colors.color1;document.getElementById("hex2").textContent=this.colors.color2;document.getElementById("hex3").textContent=this.colors.color3},setupColorPickers(){["color1","color2","color3"].forEach((id,index)=>{const colorInput=document.getElementById(id);const hexDisplay=document.getElementById(`hex${index+1}`);colorInput.addEventListener("input",e=>{hexDisplay.textContent=e.target.value})})},setupButtons(){const confirmBtn=document.getElementById("confirmColors");const cancelBtn=document.getElementById("cancelColors");if(confirmBtn){confirmBtn.addEventListener("click",()=>{this.colors.color1=document.getElementById("color1").value;this.colors.color2=document.getElementById("color2").value;this.colors.color3=document.getElementById("color3").value;localStorage.setItem("teamColors",JSON.stringify(this.colors));this.showFeedback("Colors saved!");if(window.CardApp){window.CardApp.updateCard()}})}if(cancelBtn){cancelBtn.addEventListener("click",()=>{this.applyColors();this.showFeedback("Changes cancelled")})}},showFeedback(message){const feedback=document.getElementById("colorFeedback");if(feedback){feedback.textContent=message;feedback.style.opacity="1";setTimeout(()=>{feedback.style.opacity="0"},2e3)}},getColors(){return this.colors}};document.addEventListener("DOMContentLoaded",()=>{if(document.getElementById("color1")){window.TeamColors.init()}});