window.CardRenderer={drawR(ctx,x,y,w,h,r,fill,stroke){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();if(fill)ctx.fill();if(stroke)ctx.stroke()},wrapText(ctx,text,x,y,maxWidth,lineHeight){if(!text)return;const words=text.split(" ");let line="";for(let n=0;n<words.length;n++){let testLine=line+words[n]+" ";let metrics=ctx.measureText(testLine);if(metrics.width>maxWidth&&n>0){ctx.fillText(line,x,y);line=words[n]+" ";y+=lineHeight}else{line=testLine}}ctx.fillText(line,x,y)},renderFront(data,userImages){const teamColors=window.TeamColors?window.TeamColors.getColors():null;const canvas=document.getElementById("hidden-canvas-front");const playerCanvas=document.getElementById("hidden-canvas-player");const borderCanvas=document.getElementById("hidden-canvas-border");const ctx=canvas.getContext("2d");const pCtx=playerCanvas.getContext("2d");const bCtx=borderCanvas.getContext("2d");const w=1024,h=1480;[ctx,pCtx,bCtx].forEach(c=>c.clearRect(0,0,w,h));if(userImages.layerBg){ctx.drawImage(userImages.layerBg,0,0,w,h)}else{ctx.fillStyle="#0f172a";ctx.fillRect(0,0,w,h)}if(userImages.layerPlayer){pCtx.drawImage(userImages.layerPlayer,0,0,w,h)}if(userImages.layerBorder){bCtx.drawImage(userImages.layerBorder,0,0,w,h)}},renderBack(data,userImages){const teamColors=window.TeamColors?window.TeamColors.getColors():null;const canvas=document.getElementById("hidden-canvas-back");const vpCanvas=document.getElementById("hidden-canvas-vp");const lCanvas=document.getElementById("hidden-canvas-league");const ctx=canvas.getContext("2d");const vpCtx=vpCanvas?vpCanvas.getContext("2d"):null;const lCtx=lCanvas?lCanvas.getContext("2d"):null;const w=1024,h=1480;const pad=60;ctx.clearRect(0,0,w,h);if(vpCtx)vpCtx.clearRect(0,0,w,h);if(lCtx)lCtx.clearRect(0,0,w,h);if(userImages.back){ctx.drawImage(userImages.back,0,0,w,h)}else{ctx.fillStyle="#f8fafc";ctx.fillRect(0,0,w,h)}const plateWidth=w-pad*2.5;const plateX=(w-plateWidth)/2;const logoSize=135;const logoY=425;if(userImages.vpLogo){const logoX=(w-logoSize)/2-300;ctx.drawImage(userImages.vpLogo,logoX,logoY,logoSize,logoSize);if(vpCtx)vpCtx.drawImage(userImages.vpLogo,logoX,logoY,logoSize,logoSize)}if(userImages.lLogo){const logoX=(w-logoSize)/2+300;ctx.drawImage(userImages.lLogo,logoX,logoY,logoSize,logoSize);if(lCtx)lCtx.drawImage(userImages.lLogo,logoX,logoY,logoSize,logoSize)}const position=data.pPosition||"SS";ctx.fillStyle="#1e293b";ctx.font='bold 48px "Bebas Neue", "Impact", sans-serif';ctx.textAlign="center";ctx.fillText(position,w/2,340);const number=data.pNumber||"00";const centerX=w/2;const centerY=590;ctx.font='900 240px "Bebas Neue", "Impact", sans-serif';ctx.textAlign="center";ctx.lineJoin="round";ctx.strokeStyle=teamColors?teamColors.color2:"#64748b";ctx.lineWidth=15;ctx.strokeText(number,centerX,centerY);ctx.fillStyle=teamColors?teamColors.color1:"#1e293b";ctx.fillText(number,centerX,centerY);const highlightY=750;ctx.fillStyle="#111";ctx.font=`bold 36px Arial`;ctx.fillText("HIGHLIGHTS",w/2,highlightY);ctx.font=`italic 32px Georgia`;this.wrapText(ctx,data.quote||"NO HIGHLIGHTS PROVIDED",w/2,highlightY+55,plateWidth-40,42);const statsY=975;const statsHeight=400;ctx.fillStyle="#111";ctx.font="bold 32px Arial";ctx.fillText("SEASON 26 ATTRIBUTES",w/2,statsY+50);const statList=[{l:"SPD",v:data.stats.spd},{l:"AGI",v:data.stats.agi},{l:"STR",v:data.stats.str},{l:"JMP",v:data.stats.jmp},{l:"P RSH",v:data.stats.prsh},{l:"R CVR",v:data.stats.rcvr},{l:"CTH",v:data.stats.cth},{l:"HOT B",v:data.stats.hotb},{l:"TCK",v:data.stats.tck},{l:"STA",v:data.stats.sta},{l:"DUR",v:data.stats.dur},{l:"LDR",v:data.stats.ldr},{l:"CMP",v:data.stats.cmp},{l:"CNST",v:data.stats.cnst},{l:"AGG",v:data.stats.agg}];const rows=3;const cols=5;const colWidth=plateWidth/cols;const rowHeight=(statsHeight-80)/rows;statList.forEach((s,i)=>{const col=i%cols;const row=Math.floor(i/cols);const sx=plateX+col*colWidth+colWidth/2;const sy=statsY+80+row*rowHeight;ctx.fillStyle="#64748b";ctx.font=`bold 20px Arial`;ctx.fillText(s.l,sx,sy+35);ctx.fillStyle="#1e293b";ctx.font=`900 38px Arial`;ctx.fillText(s.v||"-",sx,sy+80)})}};window.switchView=function(viewId){const views=["view-home","view-creator","view-vault","view-inspect"];views.forEach(v=>{const el=document.getElementById(v);if(el)el.classList.add("hidden")});const targetView=document.getElementById("view-"+viewId);if(targetView)targetView.classList.remove("hidden");const creatorViewport=document.getElementById("viewport");const inspectViewport=document.getElementById("viewport-inspect");if(window.CardApp&&window.CardApp.renderer){const rendererElement=window.CardApp.renderer.domElement;if(viewId==="inspect"&&inspectViewport){inspectViewport.appendChild(rendererElement);setTimeout(()=>window.CardApp.handleResize("viewport-inspect"),50)}else if(viewId==="creator"&&creatorViewport){creatorViewport.appendChild(rendererElement);setTimeout(()=>window.CardApp.handleResize("viewport"),50)}}if(viewId==="vault"&&window.CardApp.renderGallery){window.CardApp.renderGallery()}};window.toggleIdMode=function(){const mode=document.querySelector('input[name="idMode"]:checked')?.value||"builder";const builderSettings=document.getElementById("builder-settings");if(builderSettings){if(mode==="png"){builderSettings.classList.add("hidden")}else{builderSettings.classList.remove("hidden")}}if(window.CardApp&&window.CardApp.updateCard){window.CardApp.updateCard()}};window.toggleNickSettings=function(){const drawer=document.getElementById("nickSettings");if(drawer)drawer.classList.toggle("hidden")};window.UIHandler={init(){console.log("VSC UIHandler: Terminal Interface Linked.");this.bindFileUpload("imgLayerBg","layerBg");this.bindFileUpload("imgLayerPlayer","layerPlayer");this.bindFileUpload("imgLayerBorder","layerBorder");this.bindFileUpload("imgBack","back");this.bindFileUpload("vpLogo","vpLogo");this.bindFileUpload("lLogo","lLogo");["input","change"].forEach(eventType=>{document.addEventListener(eventType,e=>{if(e.target.closest(".sidebar")){if(window.CardApp&&window.CardApp.updateCard){window.CardApp.updateCard()}}})})},bindFileUpload(id,key){const el=document.getElementById(id);if(!el)return;el.onchange=e=>{const reader=new FileReader;reader.onload=ev=>{const img=new Image;img.onload=()=>{window.CardApp.userImages[key]=img;console.log(`Uploaded ${key}:`,window.CardApp.userImages);window.CardApp.updateCard()};img.src=ev.target.result};if(e.target.files[0])reader.readAsDataURL(e.target.files[0])}},getFormData(){const getVal=id=>document.getElementById(id)?.value||"";const getNum=id=>parseFloat(document.getElementById(id)?.value||0);const getChecked=id=>document.getElementById(id)?.checked||false;const mode=document.querySelector('input[name="idMode"]:checked')?.value||"builder";const currentCount=parseInt(localStorage.getItem("vsc_counter")||"0");const previewSerial=`VSC-${currentCount+1}`;["X","Y","Rot","Scale"].forEach(s=>{const label=document.getElementById(`val${s}`);const input=document.getElementById(`nick${s}`);if(label&&input)label.innerText=input.value});return{mode:mode,serial:previewSerial,fName:getVal("fName"),fNameColor:getVal("fNameColor"),fNameFont:getVal("fNameFont"),pNumber:getVal("pNumber"),pPosition:getVal("pPosition"),lName:getVal("lName"),lNameColor:getVal("lNameColor"),lNameFont:getVal("lNameFont"),team:getVal("team"),teamColor:getVal("teamColor"),teamFont:getVal("teamFont"),rarityTier:getVal("rarityTier"),themeColor:getVal("themeColor"),isFoil:getChecked("isFoil"),holoBg:document.getElementById("holoBg")?.checked||false,holoPlayer:document.getElementById("holoPlayer")?.checked||false,holoBorder:document.getElementById("holoBorder")?.checked||false,backColor:getVal("backColor"),quote:getVal("quote"),stats:{spd:getVal("spd"),agi:getVal("agi"),str:getVal("str"),jmp:getVal("jmp"),prsh:getVal("prsh"),rcvr:getVal("rcvr"),cth:getVal("cth"),hotb:getVal("hotb"),tck:getVal("tck"),sta:getVal("sta"),dur:getVal("dur"),ldr:getVal("ldr"),cmp:getVal("cmp"),cnst:getVal("cnst"),agg:getVal("agg")}}}};const cardVertexShader=`\n    varying vec2 vUv;\n    varying vec3 vNormal;\n    varying vec3 vWorldPos;\n\n    void main() {\n        vUv = uv;\n        vNormal = normalize(normalMatrix * normal);\n        vec4 worldPos = modelMatrix * vec4(position, 1.0);\n        vWorldPos = worldPos.xyz;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    }\n`;const cardFragmentShader=`\n    precision highp float;\n    #define PI 3.14159265\n    varying vec2 vUv;\n    varying vec3 vNormal;\n    varying vec3 vWorldPos;\n\n    uniform sampler2D map;\n    uniform sampler2D envMap2D;\n    uniform sampler2D uFlakeMap;\n    \n    uniform vec3 uCameraPos;\n    uniform float uFlakesEnabled;\n    uniform float uFlakeSize;\n    uniform float uFlakeReduction;\n    uniform float uFlakeBrightness;\n    uniform float uMetalness;\n    uniform float uIridescence;\n    uniform float uEnvIntensity;\n\n    float luminance(vec3 color) {\n        return dot(color, vec3(0.2126, 0.7152, 0.0722));\n    }\n\n    vec2 dirToEquirectUv(vec3 dir) {\n        dir = normalize(dir);\n        float phi = atan(dir.z, dir.x);\n        float theta = acos(clamp(dir.y, -1.0, 1.0));\n        return vec2((phi + PI) / (2.0 * PI), theta / PI);\n    }\n\n    vec3 iridescenceColor(float cosTheta) {\n        float phase = 6.28318 * (0.2 + 0.5 * (1.0 - cosTheta));\n        vec3 rainbow = 0.5 + 0.5 * vec3(sin(phase), sin(phase + 2.094), sin(phase + 4.188));\n        return mix(vec3(1.0), rainbow, uIridescence);\n    }\n\n    void main() {\n        vec4 base = texture2D(map, vUv);\n        \n        // DISCARD transparent pixels (This acts as our mask for the layers)\n        if(base.a < 0.1) discard;\n\n        vec3 N = normalize(vNormal);\n        vec3 V = normalize(uCameraPos - vWorldPos);\n        vec3 R = reflect(-V, N);\n        float cosTheta = clamp(dot(N, V), 0.0, 1.0);\n\n        vec3 env = texture2D(envMap2D, dirToEquirectUv(R)).rgb * uEnvIntensity;\n        vec3 iri = iridescenceColor(cosTheta);\n        vec3 holoTint = base.rgb * iri;\n        \n        vec3 sparkleCol = vec3(0.0);\n        if(uFlakesEnabled > 0.5) {\n            vec4 flakeTex = texture2D(uFlakeMap, vUv * uFlakeSize);\n            float mask = smoothstep(uFlakeReduction, 1.0, flakeTex.r);\n            \n            vec3 flakeNorm = normalize(N + vec3((flakeTex.r - 0.5) * 0.7, (flakeTex.g - 0.5) * 0.7, (flakeTex.b - 0.5) * 0.7));\n            vec3 PR = reflect(-V, flakeNorm);\n            float lightHit = luminance(texture2D(envMap2D, dirToEquirectUv(PR)).rgb);\n            \n            float glint = pow(lightHit, 16.0) * mask; \n            vec3 fire = 0.5 + 0.5 * cos(6.28318 * (flakeTex.g + vec3(0, 1, 2) / 3.0));\n            sparkleCol = glint * fire * uFlakeBrightness * 100.0;\n        }\n\n        // Apply holographic effect\n        vec3 diffuse = mix(base.rgb, holoTint, uMetalness);\n        vec3 specular = (env * 0.4) * iri * uMetalness;\n        vec3 finalColor = diffuse + specular + sparkleCol + (iri * 0.1);\n        \n        gl_FragColor = vec4(finalColor, base.a);\n    }\n`;window.CardApp={scene:null,camera:null,renderer:null,cardMesh:null,envMap:null,flakeMap:null,isFlipped:false,userImages:{layerBg:null,layerPlayer:null,layerBorder:null,back:null,vpLogo:null,lLogo:null},flakeOptions:["broken-glass.jpg","flakes.jpg","gold.jpg","oil.jpg","shards.jpg","fire.jpg","foil1.jpg","checkered.jpg","geometric.jpg","geometric2.jpg","retro.jpg","stained-glass.jpg"],init(){const viewport=document.getElementById("viewport");if(!viewport)return;window.UIHandler?.init();this.scene=new THREE.Scene;this.camera=new THREE.PerspectiveCamera(35,viewport.clientWidth/viewport.clientHeight,.1,1e3);this.camera.position.z=12;this.renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});this.renderer.setSize(viewport.clientWidth,viewport.clientHeight);this.renderer.setPixelRatio(window.devicePixelRatio);this.renderer.outputColorSpace=THREE.SRGBColorSpace;viewport.appendChild(this.renderer.domElement);const loader=new THREE.TextureLoader;loader.setCrossOrigin("anonymous");this.envMap=loader.load("assets/environment-maps/room-envmap.jpg",tex=>{tex.mapping=THREE.EquirectangularReflectionMapping;this.updateCard()});this.flakeMap=loader.load("assets/foil-textures/broken-glass.jpg",tex=>{const imageRatio=tex.image.width/tex.image.height;if(imageRatio>1){tex.rotation=Math.PI/2;tex.center.set(.5,.5)}tex.wrapS=tex.wrapT=THREE.RepeatWrapping;this.updateCard()});const ambient=new THREE.AmbientLight(16777215,.8);this.scene.add(ambient);const pointLight=new THREE.PointLight(16777215,.8);pointLight.position.set(5,5,10);this.scene.add(pointLight);this.createFlakeDropdown();this.setupInteraction();this.updateCard();this.animate();window.addEventListener("resize",()=>this.handleResize())},createFlakeDropdown(){const container=document.getElementById("ui-controls");if(!container)return;const wrapper=document.createElement("div");wrapper.style.padding="10px";wrapper.style.background="rgba(0,0,0,0.5)";wrapper.style.borderRadius="5px";wrapper.style.marginTop="10px";const label=document.createElement("label");label.innerText="Foil Pattern: ";label.style.color="white";label.style.fontSize="12px";const select=document.createElement("select");select.style.background="#222";select.style.color="white";select.style.border="1px solid #444";this.flakeOptions.forEach(fileName=>{const option=document.createElement("option");option.value=`assets/foil-textures/${fileName}`;option.innerText=fileName.replace(".jpg","").toUpperCase();select.appendChild(option)});select.addEventListener("change",e=>this.changeFlakeTexture(e.target.value));wrapper.appendChild(label);wrapper.appendChild(select);container.appendChild(wrapper)},changeFlakeTexture(path){const loader=new THREE.TextureLoader;loader.load(path,tex=>{tex.wrapS=tex.wrapT=THREE.RepeatWrapping;this.flakeMap=tex;this.updateCard()})},handleResize(){const vp=document.getElementById("viewport");if(!vp||!this.camera||!this.renderer)return;this.camera.aspect=vp.clientWidth/vp.clientHeight;this.camera.updateProjectionMatrix();this.renderer.setSize(vp.clientWidth,vp.clientHeight)},updateCard(vaultData=null){if(!window.CardApp||!window.CardRenderer)return;const data=vaultData||window.UIHandler.getFormData();window.CardRenderer.renderFront(data,this.userImages);window.CardRenderer.renderBack(data,this.userImages);const getCanvasTex=id=>{const el=document.getElementById(id);if(!el)return null;const tex=new THREE.CanvasTexture(el);tex.flipY=true;tex.anisotropy=this.renderer.capabilities.getMaxAnisotropy();return tex};const texF=getCanvasTex("hidden-canvas-front");const texB=getCanvasTex("hidden-canvas-back");const texP=getCanvasTex("hidden-canvas-player");const texBorder=getCanvasTex("hidden-canvas-border");const texVP=getCanvasTex("hidden-canvas-vp");const texLL=getCanvasTex("hidden-canvas-league");const maxAnisotropy=this.renderer.capabilities.getMaxAnisotropy();[texF,texB,texP,texBorder,texVP,texLL].forEach(t=>{t.flipY=true;t.anisotropy=maxAnisotropy;t.needsUpdate=true});if(this.cardMesh){this.cardMesh.traverse(child=>{if(child.isMesh){child.geometry.dispose();if(Array.isArray(child.material)){child.material.forEach(m=>m.dispose())}else{child.material.dispose()}}});this.scene.remove(this.cardMesh)}const sideMat=new THREE.MeshStandardMaterial({color:1118481});const backMat=new THREE.MeshStandardMaterial({map:texB,envMap:this.envMap,roughness:.7,metalness:.1,envMapIntensity:.5});const getMaterial=(tex,isHoloEnabled,isTransparent=false)=>{const shouldShowHolo=isHoloEnabled||data.isFoil||data.rarityTier==="Legendary";if(shouldShowHolo){return new THREE.ShaderMaterial({uniforms:{map:{value:tex},envMap2D:{value:this.envMap},uFlakeMap:{value:this.flakeMap},uCameraPos:{value:(new THREE.Vector3).copy(this.camera.position)},uFlakesEnabled:{value:1},uFlakeSize:{value:1},uFlakeReduction:{value:.65},uFlakeBrightness:{value:.18},uMetalness:{value:.4},uIridescence:{value:.8},uEnvIntensity:{value:1.2}},vertexShader:cardVertexShader,fragmentShader:cardFragmentShader,transparent:true,depthWrite:!isTransparent})}return new THREE.MeshStandardMaterial({map:tex,envMap:this.envMap,envMapIntensity:.4,transparent:isTransparent,alphaTest:isTransparent?.1:0,roughness:.8,metalness:.1})};const frontMat=getMaterial(texF,data.holoBg,false);this.cardMesh=new THREE.Mesh(new THREE.BoxGeometry(3.5,5,.1),[sideMat,sideMat,sideMat,sideMat,frontMat,backMat]);this.scene.add(this.cardMesh);const pMat=getMaterial(texP,data.holoPlayer,true);const pMesh=new THREE.Mesh(new THREE.PlaneGeometry(3.5,5),pMat);pMesh.position.z=.051;this.cardMesh.add(pMesh);const bMat=getMaterial(texBorder,data.holoBorder,true);const bMesh=new THREE.Mesh(new THREE.PlaneGeometry(3.5,5),bMat);bMesh.position.z=.052;this.cardMesh.add(bMesh);const vpLogoMesh=new THREE.Mesh(new THREE.PlaneGeometry(3.5,5),getMaterial(texVP,data.isFoil,true));vpLogoMesh.position.z=-.051;vpLogoMesh.rotation.y=Math.PI;this.cardMesh.add(vpLogoMesh);const lLogoMesh=new THREE.Mesh(new THREE.PlaneGeometry(3.5,5),getMaterial(texLL,data.isFoil,true));lLogoMesh.position.z=-.052;lLogoMesh.rotation.y=Math.PI;this.cardMesh.add(lLogoMesh)},animate(){requestAnimationFrame(()=>this.animate());const camPos=this.camera.position;if(this.cardMesh){if(this.cardMesh.material[4].type==="ShaderMaterial"){this.cardMesh.material[4].uniforms.uCameraPos.value.copy(camPos)}this.cardMesh.children.forEach(child=>{if(child.material&&child.material.type==="ShaderMaterial"){child.material.uniforms.uCameraPos.value.copy(camPos)}})}this.renderer.render(this.scene,this.camera)},setupInteraction(){let drag=false,prev={x:0,y:0};window.addEventListener("mousedown",e=>{if(e.target.closest("#viewport")){drag=true;prev={x:e.clientX,y:e.clientY}}});window.addEventListener("mouseup",()=>drag=false);window.addEventListener("mousemove",e=>{if(!drag||!this.cardMesh)return;this.cardMesh.rotation.y+=(e.clientX-prev.x)*.01;this.cardMesh.rotation.x+=(e.clientY-prev.y)*.01;prev={x:e.clientX,y:e.clientY}})}};window.addEventListener("load",()=>window.CardApp.init());window.TeamColors={colors:{color1:"#ff4444",color2:"#44ff44",color3:"#4444ff"},init(){this.loadColors();this.setupColorPickers();this.setupButtons()},loadColors(){const saved=localStorage.getItem("teamColors");if(saved){this.colors=JSON.parse(saved);this.applyColors()}},applyColors(){document.getElementById("color1").value=this.colors.color1;document.getElementById("color2").value=this.colors.color2;document.getElementById("color3").value=this.colors.color3;document.getElementById("hex1").textContent=this.colors.color1;document.getElementById("hex2").textContent=this.colors.color2;document.getElementById("hex3").textContent=this.colors.color3},setupColorPickers(){["color1","color2","color3"].forEach((id,index)=>{const colorInput=document.getElementById(id);const hexDisplay=document.getElementById(`hex${index+1}`);colorInput.addEventListener("input",e=>{hexDisplay.textContent=e.target.value})})},setupButtons(){const confirmBtn=document.getElementById("confirmColors");const cancelBtn=document.getElementById("cancelColors");if(confirmBtn){confirmBtn.addEventListener("click",()=>{this.colors.color1=document.getElementById("color1").value;this.colors.color2=document.getElementById("color2").value;this.colors.color3=document.getElementById("color3").value;localStorage.setItem("teamColors",JSON.stringify(this.colors));this.showFeedback("Colors saved!");if(window.CardApp){window.CardApp.updateCard()}})}if(cancelBtn){cancelBtn.addEventListener("click",()=>{this.applyColors();this.showFeedback("Changes cancelled")})}},showFeedback(message){const feedback=document.getElementById("colorFeedback");if(feedback){feedback.textContent=message;feedback.style.opacity="1";setTimeout(()=>{feedback.style.opacity="0"},2e3)}},getColors(){return this.colors}};document.addEventListener("DOMContentLoaded",()=>{if(document.getElementById("color1")){window.TeamColors.init()}});